// SHAKER.IO INSTRUMENTED VERSION

<% include lib/jquery-1.10.1.min.js %>

(function(origin, frame_src){

	// set up the transport.

	var domready = <% include lib/domready.js %>;

	var ifr = document.createElement('iframe');
	ifr.setAttribute('style', 'display:none');
	ifr.setAttribute('src', frame_src);

	domready(function(){
		document.body.appendChild(ifr);	
	});

	var transport_active = false;
	var transport_pending = [];

	window.addEventListener('message', function(e){
		if(e.origin === origin){
			console.log("yes, from the iframe")
			transport_active = true;
			transport_pending.forEach(emit);
			transport_pending = [];
		}
	}, false);


	// send the message to the parent window
	function emit(message){
		if(transport_active){
			ifr.contentWindow.postMessage(message,origin);
		} else{
			// queue up the messges
			transport_pending.push(message);
		}
	}


})("<%= origin %>","<%= frame_src %>");