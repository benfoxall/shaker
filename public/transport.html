<html>
<head>
	<title>transport</title>

	<!--
		This listens for postMessage events and persists them to localStorage
		Which allows cross origin, cross window transfer
	-->

	<script type="text/javascript">
		var localStoreKey = 'deps';

		window.addEventListener('message', function(e){
			console.log('>>', e.data);
			// update the js dependencies object
			var deps_str = localStorage.getItem(localStoreKey) || '{}';

			var deps = JSON.parse(deps_str);

			// a.b.c=d
			var key_value = e.data.split('=');
			var keys = key_value[0].split('.');

			var target = deps;
			for (var i = 0; i < keys.length; i++) {
				var k = keys[i];

				if(i == keys.length - 1){
					target[k] = key_value[1]
				} else{
					if(typeof(target[k]) == 'undefined'){
						target[k] = {};
					}
					target = target[k];
				}
			};

			console.log("dependencies:", deps)

			localStorage.setItem(localStoreKey, JSON.stringify(deps));

		}, false);
	</script>
</head>
<body />
</html>